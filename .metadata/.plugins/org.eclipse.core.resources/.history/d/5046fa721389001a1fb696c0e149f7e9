package CodingStudyHW;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.PriorityQueue;
import java.util.StringTokenizer;

/*
 * 1:40 시작
 * 차근차근
 * 
1
7 2 9
1 1 7 1
2 1 7 1
5 1 5 4
3 2 8 4
4 3 14 1
3 4 3 3
1 5 8 2
3 5 100 1
5 5 1 1
 */
public class 미생물격리 {
	static int T;
	static class Microorganism implements Comparable<Microorganism>{
		int row;
		int col;
		int crowd;
		int dir;
		int idx;
		boolean alive;
		public Microorganism(int row, int col,int crowd, int dir, int idx, boolean alive) {
			this.row = row;
			this.col = col;
			this.crowd= crowd;
			this.dir = dir;
			this.idx = idx;
			this.alive = alive;
		}
		@Override
		public int compareTo(Microorganism o) {
			return -Integer.compare(this.crowd,o.crowd);//군집 이 큰 순서 - 내림차순
		}
	}
	static PriorityQueue<Microorganism>[][] cellMap;
	static BufferedReader br = new BufferedReader(new InputStreamReader(System.in));
	static StringTokenizer st;
	static int N,M,K;
	static Microorganism[] micros;
	static int answer;
	static int[] dr = {0,-1,1,0,0};
	static int[] dc = {0,0,0,-1,1};//X,상,하,좌,우
	public static void main(String[] args) throws NumberFormatException, IOException {
		T = Integer.parseInt(br.readLine());
		for(int testcase=1;testcase<=T;testcase++){
			setData();
			timerON();
			getAliveMicroorganusims();
			System.out.println("#"+testcase+" "+answer);
		}
	}
	private static void getAliveMicroorganusims() {
		for(int i=0;i<K;i++) {
			if(micros[i].alive) answer+=micros[i].crowd;
		}
	}
	private static void timerON() {
		int time=1;
		while(time<=M){
			//1.군집 이동 
			moveMicroorganism();
			//2.cellMap에서 군집 체크 후 군집 병합
			mergeMicroorganism();
			time++;
//			System.out.println(time+"시간");
//			for(int i=0;i<K;i++) {
//				System.out.println(i+"번째 미생물정보");
//				System.out.println(micros[i].alive);
//				System.out.println("미생물수"+ micros[i].crowd);
//				System.out.println(micros[i].row+" "+micros[i].col);
//				System.out.println();
//			}
		}
	}
	private static void mergeMicroorganism() {
		for(int row=0;row<N;row++) {
			for(int col=0;col<N;col++) {
				if(cellMap[row][col].size()>1){//군집이 여러개 있으면
					Microorganism maxM = cellMap[row][col].poll(); //제일 큰 군집 먼저 뺌
					int sum = maxM.crowd;
					while(!cellMap[row][col].isEmpty()){//나머지 군집들 
						Microorganism nextM = cellMap[row][col].poll();
						sum+=nextM.crowd;//군집 더함
						micros[nextM.idx].alive = false;//없앰
					}
					maxM.crowd = sum;//군집 갱신 후 
					cellMap[row][col].add(micros[maxM.idx]);
				}
			}
		}
	}
	private static void moveMicroorganism() {
		for(int i=0;i<K;i++){
			if(micros[i].alive){//살아있는 군집만 이동 시킨다.
				Microorganism currentM = cellMap[micros[i].row][micros[i].col].poll();
				int cr = currentM.row;
				int cc = currentM.col;
				int ccrowd = currentM.crowd;
				int dir = currentM.dir;
				int nr = cr+dr[dir];
				int nc = cc+dc[dir];
				if(rangeCheck(nr,nc)) {//가려고하는 땅이 빨간 약품이면
					ccrowd/=2;
					if(ccrowd>0){//빨간 약품에 갔는데 살아 남는 경우만
						dir = reverseDirection(dir);
						micros[i].dir = dir;
						micros[i].row = nr;
						micros[i].col = nc;
						micros[i].crowd = ccrowd;
						cellMap[nr][nc].add(micros[i]);
					}else {
						micros[i].crowd=0;
						micros[i].alive = false;//죽음
					}
				}else {//가려고하는 땅이 빨간 약품이 아니면 일단 이동
					micros[i].dir = dir;
					micros[i].row = nr;
					micros[i].col = nc;
					micros[i].crowd = ccrowd;
					cellMap[nr][nc].add(micros[i]);
				}
			}
		}
	}
	private static int reverseDirection(int dir) {
		int reverseDir = 0;
		if(dir%2==0) reverseDir = dir-1;
		if(dir%2!=0) reverseDir = dir+1;
		return reverseDir;
	}
	private static boolean rangeCheck(int nr, int nc) {
		if(nr==0 || nr==(N-1) || nc==0 || nc==(N-1)) return true;
		return false;
	}
	private static void setData() throws IOException {
		st = new StringTokenizer(br.readLine());
		N = Integer.parseInt(st.nextToken());
		M = Integer.parseInt(st.nextToken());
		K = Integer.parseInt(st.nextToken());
		cellMap = new PriorityQueue[N][N];
		micros = new Microorganism[K];
		answer = 0;
		for(int row=0;row<N;row++) {
			for(int col=0;col<N;col++) {
				cellMap[row][col] = new PriorityQueue<Microorganism>();
			}
		}
		for(int i=0,row,col,crowd,dir;i<K;i++) {
			st = new StringTokenizer(br.readLine());
			row = Integer.parseInt(st.nextToken());
			col = Integer.parseInt(st.nextToken());
			crowd = Integer.parseInt(st.nextToken());
			dir = Integer.parseInt(st.nextToken());
			micros[i] = new Microorganism(row, col, crowd, dir, i, true);
			cellMap[row][col].add(micros[i]); //cellMap에 투입
		}
		
	}
}
